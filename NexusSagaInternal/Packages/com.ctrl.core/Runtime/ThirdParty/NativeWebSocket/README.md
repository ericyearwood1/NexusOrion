Adapted from https://github.com/endel/NativeWebSocket @ a15bc624f51ec02bee2392e705598f5409a0abe0
With fixes in https://github.com/endel/NativeWebSocket/pull/69
